<div class="container">
    <div class="row">

        <div class="jumbotron">
            <h1>CVR</h1>
            <p>View line-by-line coverage reports by posting code coverage in LCOV, Cobertura, or Jacoco.</p>

            {{#if authed}}
                <p><a href="/repos">Browse repos</a> to view coverage or get a token to post coverage.</p>
            {{else}}<p><a class="btn btn-primary btn-lg" href="/auth/github">
                Log in with GitHub</a></p>
            {{/if}}

        </div>


        <h2>
            Use
        </h2>


        <h3>curl</h3>

<pre>
<code>
curl -F coverage=@coverage.info "https://cvr.vokal.io/coverage?token=:TOKEN&commit=:COMMIT_HASH&coveragetype=:COVERAGE_TYPE&removepath=:REMOVE_PATH"
</code>
</pre>

        <h3>Details</h3>
        <ul class="list-group">
            <li class="list-group-item">
                <strong>coverage</strong> (required)<br>
                The coverage file contents posted in multipart format
            </li>
            <li class="list-group-item">
                <strong>token</strong> (required unless providing owner and repo)<br>
                The token provided with each repo, <a href="/repos">browse repos to get a token</a>
            </li>
            <li class="list-group-item">
                <strong>owner</strong> (required unless providing token)<br>
                The owner of the repo
            </li>
            <li class="list-group-item">
                <strong>repo</strong> (required unless providing token)<br>
                The repo name
            </li>
            <li class="list-group-item">
                <strong>commit</strong> (required)<br>
                The git commit hash. In bash you can get this like <code>COMMIT_HASH="$(git rev-parse HEAD)"</code>
            </li>
            <li class="list-group-item">
                <strong>coveragetype</strong> (optional, lcov|cobertura, default is lcov)<br>
                The type of coverage being sent
            </li>
            <li class="list-group-item">
                <strong>removepath</strong> (optional)<br>
                A file path segment that will be removed from paths in the coverage data. This makes it easier to
                map paths in coverage data to paths in the git repo.
                <em>Line by line coverage will not be available if the coverage paths
                do not match the paths from the git project root.</em><br>

                For example, if a path looks like /User/docs/build/file.js, use removepath=/User/docs/
                to map the path to build/file.js
            </li>
            <li class="list-group-item">
                <strong>prependpath</strong> (optional)<br>
                A file path segment that will be prepended to paths in the coverage data. This makes it easier to
                map paths in coverage data to paths in the git repo.
                <em>Line by line coverage will not be available if the coverage paths
                do not match the paths from the git project root.</em><br>

                For example, if a path looks like file.js, use prependpath=project/
                to map the path to project/file.js
            </li>
        </ul>

        <h3>Travis</h3>

        <p>This script can be used to work with Travis, which doesn't make the token available on pull requests.
        This includes getting the repo name and owner from Travis, but they can be hardcoded as well.
        </p>

<pre>
<code>
#!/bin/bash

LCOV_OUTPUT_DIR="${BUILT_PRODUCTS_DIR}/lcov"

if [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then
    # Upload the non-PR coverage to cvr.vokal.io
    curl -F coverage=@"${LCOV_OUTPUT_DIR}/Coverage.info" \
        "https://cvr.vokal.io/coverage?token=${CVR_TOKEN}&commit=${TRAVIS_COMMIT}&removepath=${TRAVIS_BUILD_DIR}"

    # Exit successfully (so that the pull-request type uploading doesn't happen).
    exit 0
fi

# For PRs, we have to do some more fiddling to get the proper commit hash ($TRAVIS_COMMIT is the hash of a merge
# that Travis makes, not the hash of the last commit in the PR)...
LAST_PR_COMMIT="${TRAVIS_COMMIT_RANGE##*...}"
# ... and we have to split the repo slug to get repo owner and name.
REPO_OWNER="${TRAVIS_REPO_SLUG%%/*}"
REPO_NAME="${TRAVIS_REPO_SLUG##*/}"
# Let's put those into a URL query string fragment, to make the lines in this script shorter.
GIT_PARAMS="commit=${LAST_PR_COMMIT}&owner=${REPO_OWNER}&repo=${REPO_NAME}"
# Do the actual upload of PR coverage to cvr.vokal.io.
URL="https://cvr.vokal.io/coverage?${GIT_PARAMS}&removepath=${TRAVIS_BUILD_DIR}&ispullrequest=1"
curl -F coverage=@"${LCOV_OUTPUT_DIR}/Coverage.info" "${URL}"
</code>
</pre>

    </div>
</div>
